name: Update Filtered EPG Daily (Gist)

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-epg:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download latest EPG source
        run: |
          curl -L --fail -A "Mozilla/5.0" \
            -o epg_ripper_ALL_SOURCES1.gz \
            "https://epgshare01.online/epgshare01/epg_ripper_ALL_SOURCES1.xml.gz"

          ls -lh epg_ripper_ALL_SOURCES1.gz
          file epg_ripper_ALL_SOURCES1.gz

          if file epg_ripper_ALL_SOURCES1.gz | grep -qi html; then
            echo "ERROR: Downloaded HTML instead of gz"
            exit 1
          fi

      - name: Run filter script
        run: |
          python filter_epg.py
          ls -lh filtered_epg.xml.gz

      # ✅ Upload to Gist
      - name: Upload filtered EPG to Gist
        env:
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
          GIST_ID: ${{ secrets.GIST_ID }}
        run: |
          python - << 'PY'
          import os, json, base64, urllib.request

          gist_id = os.environ["GIST_ID"]
          token = os.environ["GIST_TOKEN"]

          filename = "filtered_epg.xml.gz"
          with open(filename, "rb") as f:
              content_b64 = base64.b64encode(f.read()).decode("utf-8")

          # Gist API expects plain text, so we'll send base64 and decode is not needed by tivimate? ❌
          # Better: Upload binary by converting to Latin-1 safe string (works for gz).
          with open(filename, "rb") as f:
              raw = f.read().decode("latin-1")

          payload = {
              "files": {
                  filename: {
                      "content": raw
                  }
              }
          }

          data = json.dumps(payload).encode("utf-8")

          req = urllib.request.Request(
              f"https://api.github.com/gists/{gist_id}",
              data=data,
              method="PATCH"
          )
          req.add_header("Authorization", f"token {token}")
          req.add_header("Accept", "application/vnd.github+json")

          with urllib.request.urlopen(req) as resp:
              print("Gist updated:", resp.status)
          PY
